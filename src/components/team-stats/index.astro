---
import { getEntry } from "astro:content";

import type { SeasonsEntry, TeamCode } from "../../content/utils";

import * as ContentUtils from "../../content/utils";
import Loading from "../loading.astro";
import TeamStats from "./ssr.astro"; // component name used in requests (dev tools, network tab); for easier id in debugging
import UI from "./ui.astro";

interface Props {
  seasonId: SeasonsEntry["id"];
  teamId: TeamCode;
}

const { seasonId, teamId } = Astro.props;

const teamSeason = await getEntry("teamSeasons", `${seasonId}/${teamId}`);

if (!teamSeason) {
  throw new Error(
    `[team-stats] team ${teamId} not found for ${seasonId} season`,
  );
}

const staticGames = await ContentUtils.getSeasonArchive(seasonId);
if (import.meta.env.DEV && !staticGames) {
  console.log(
    `[team-stats] Static games data unavailable for season ${teamSeason.data.seasonId}; will try to render data via server island`,
  );
}
---

{
  staticGames ? (
    <UI
      games={staticGames.map((gameEntry) => gameEntry.data)}
      teamSeason={teamSeason}
    />
  ) : (
    <TeamStats
      seasonId={teamSeason.data.seasonId}
      server:defer
      teamId={teamSeason.data.teamId}
    >
      <Loading slot="fallback" />
    </TeamStats>
  )
}
