# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

**Development:**

- `npm run dev` - Start local dev server with Cloudflare Workers types and type checking
- `npm run build` - Build production site (includes prebuild checks and tests)
- `npm run prebuild` - Run checks and tests before building
- `npm run check` - Run Astro check, format check, and linting
- `npm run typewatch` - Watch mode for Astro type checking

**Quality Assurance:**

- `npm run lint` - Run ESLint
- `npm run fmt` - Format code with Prettier
- `npm run fmt:check` - Check code formatting
- `npm test` - Run Vitest test suite

**Data Management:**

- `npm run archive:all` - Archive all past seasons to static JSON files
- `npm run archive:latest` - Archive only the latest season

**Development Tools:**

- `npm run kv:destroy` - Remove local Wrangler state
- `npm run kv:reset` - Reset KV store for latest season
- `npm run deps` - Interactive dependency updates
- `npm run cf:wip` - Quick commit and push for Cloudflare Pages (skip CI)

## Architecture

### Core Constraints

- Per package.json, this is a module type project. Must use ESM, not CommonJS, as the module system

### Core Data Model

This is an NBA "surprise teams" tracker that monitors teams performing above expectations based on over/under betting lines. The application has a hybrid static/dynamic architecture:

**Static Data (Past Seasons):** Historical seasons are stored as static files in `src/content/` containing:

- `seasons.json` - Season metadata and date ranges
- `teams.json` - Team information and metadata
- `teamSeasons.json` - Teams participating in each season with over/under lines
- `games.json` - Complete game results (generated by archiver)

**Dynamic Data (Current Season):** Live data fetched from NBA API via `src/loaders/live.ts` and cached in Cloudflare KV store to minimize API calls.

### Type System Architecture

The codebase uses TypeScript's literal types extensively for type safety:

- `SeasonId` - Union of valid season years (1993, 1996, 1997, etc.)
- `SeasonData` - Complex discriminated union that enforces which teams participated in each season
- `TeamCode` - Derived from `TEAM_CODES` constant for valid team identifiers

This approach ensures data entry errors are caught at compile time and restricts "queries" to valid combinations.

### Data Flow

1. **Archive Flow:** `archiver/script.ts` fetches historical data and writes `games.json` files
2. **Live Flow:** Server actions use `src/loaders/live.ts` to fetch current data, cache in KV
3. **Static Flow:** Build-time pages use content collections to load static game data
4. **Calculations:** Business logic for surprise team calculations is distributed across `src/content-utils.ts` and `src/utils.ts`

### Key Business Logic

Teams are "surprise teams" if they exceed their over/under by 10+ wins. Core calculations:

- `toSurprise()` - Minimum wins needed to be a surprise (O/U + 10)
- `pace()` - Current pace relative to surprise threshold
- `isSurprise()` / `isEliminated()` - Team status determination

### Pages & Components

- **Dynamic Pages:** Current season pages (rendered on-demand)
- **Static Pages:** Archive pages, stats aggregations
- **React Components:** Charts (`src/components/charts/`) using Recharts
- **Astro Components:** Tables, team stats displays

### Deployment

- Cloudflare Pages deployment with Cloudflare Workers adapter
- Environment-specific sites: dev.nba-surprise-teams.pages.dev (preview), nba-surprise-teams.grepco.net (production)
- Sentry integration for error tracking

### Seasonal Maintenance

The application requires updates three times per year:

1. **End of season** - Archive completed season data
2. **Schedule release** - Add new season structure
3. **Odds release** - Add teams and over/under lines

See README.md for detailed seasonal maintenance procedures.

## Testing

The project uses Vitest for testing with pre-commit hooks ensuring code quality:

- Tests run automatically before builds via `prebuild` script
- Pre-commit hooks run `prebuild` (includes tests, linting, formatting)
- Key test file: `system.test.ts` for integration testing

## Development Workflow

**Local Development:**

1. `npm run dev` - Starts concurrent Astro dev server and type watching
2. Local Wrangler state in `.wrangler/` directory for KV store simulation
3. Use `npm run kv:reset` to reset local KV data to latest season

**Code Quality:**

- ESLint configuration with multiple plugins (Astro, React, accessibility, etc.)
- Prettier with Astro and Tailwind plugins
- Strict TypeScript configuration
- Pre-commit hooks enforce quality gates

**Key Development Files:**

- `src/content-utils.ts` - Core content loading and type utilities
- `src/utils.ts` - General utilities and date/time helpers
- `src/middleware.ts` - Astro middleware for request handling
- `vitest.config.ts` - Test configuration
- `wrangler.toml` - Cloudflare Workers configuration

## Node.js Version

- **Required:** Node.js >= 22 < 23 (strictly enforced via `engineStrict`)
- Check `.nvmrc` or `package.json` engines field for version requirements

## File Ignore Instructions

To prevent context overflow and ensure efficient operation:

**Always Ignore:**

- All files listed in `.gitignore`
- All files excluded from diffing or marked as binary in `.gitattributes`

**Large Files (Partial Access Only):**

- `src/content/games.json` - When needed, use: `jq '.[0:20]' src/content/games.json` to read first 20 records and understand structure
- `src/content/teamSeasons.json` - Large file containing all team/season combinations with betting lines

**Important:** If any prompt leads to needing access to ignored files, ask for clearer instructions rather than proceeding. If there's a conflict between these ignore instructions and a task requirement, clarify with the user before proceeding.
