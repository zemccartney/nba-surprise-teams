# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Context

- I (the prompter) am a senior engineer. My job is to provide whatever context you need to do the jobs I assign you well. I do not want you to guess at what I mean or try to appease me.
- You are an LLM. You're job here is to facilitate maintenance of this site.

## Commands

**Development:**

- `npm run dev` - Start local dev server with Cloudflare Workers types and type checking
- `npm run build` - Build production site (includes type checking, formatting, and linting)
- `npm run check` - Run Astro check, format check, and linting
- `npm run typewatch` - Watch mode for Astro type checking

**Quality Assurance:**

- `npm run lint` - Run ESLint
- `npm run fmt` - Format code with Prettier
- `npm run fmt:check` - Check code formatting

**Data Management:**

- `npm run archive:all` - Archive all past seasons to static JSON files
- `npm run archive:latest` - Archive only the latest season

**Other:**

- `npm run deps` - Interactive dependency updates
- `npm run cf:wip` - Quick commit and push for Cloudflare Pages (skip CI)

## Architecture

### Core Constraints

- Per package.json, this is a module type project. Must use ESM, not CommonJS, as the module system

### Core Data Model

This is an NBA "surprise teams" tracker that monitors teams performing above expectations based on over/under betting lines. The application has a hybrid static/dynamic architecture:

**Static Data (Past Seasons):** Historical seasons are stored as static files in `src/data/seasons/{year}/` containing:

- `data.ts` - Season metadata and participating teams with their over/under lines
- `games.json` - Complete game results (generated by archiver)

**Dynamic Data (Current Season):** Live data fetched from NBA API and cached in Cloudflare KV store to minimize API calls.

### Type System Architecture

The codebase uses TypeScript's literal types extensively for type safety:

- `SeasonId` - Union of valid season years (1993, 1996, 1997, etc.)
- `SeasonData` - Complex discriminated union that enforces which teams participated in each season
- `TeamCode` - Derived from `TEAM_CODES` constant for valid team identifiers

This approach ensures data entry errors are caught at compile time and restricts "queries" to valid combinations.

### Data Flow

1. **Archive Flow:** `archiver.ts` fetches historical data and writes `games.json` files
2. **Live Flow:** Server actions use `src/data/loaders/live.ts` to fetch current data, cache in KV
3. **Static Flow:** Build-time pages use `src/data/loaders/archive.ts` to load static game data
4. **Calculations:** `src/data/seasons/index.ts` contains business logic for surprise team calculations

### Key Business Logic

Teams are "surprise teams" if they exceed their over/under by 10+ wins. Core calculations:

- `toSurprise()` - Minimum wins needed to be a surprise (O/U + 10)
- `pace()` - Current pace relative to surprise threshold
- `isSurprise()` / `isEliminated()` - Team status determination

### Pages & Components

- **Dynamic Pages:** Current season pages (rendered on-demand)
- **Static Pages:** Archive pages, stats aggregations
- **React Components:** Charts (`src/components/charts/`) using Recharts
- **Astro Components:** Tables, team stats displays

### Deployment

- Cloudflare Pages deployment with Cloudflare Workers adapter
- Environment-specific sites: dev.nba-surprise-teams.pages.dev (preview), nba-surprise-teams.grepco.net (production)
- Sentry integration for error tracking

### Seasonal Maintenance

The application requires updates three times per year:

1. **End of season** - Archive completed season data
2. **Schedule release** - Add new season structure
3. **Odds release** - Add teams and over/under lines

See README.md for detailed seasonal maintenance procedures.

## File Ignore Instructions

To prevent context overflow and ensure efficient operation:

**Always Ignore:**
- All files listed in `.gitignore`
- All files excluded from diffing or marked as binary in `.gitattributes`

**Large Files (Partial Access Only):**
- `src/content/games.json` - When needed, use: `jq '.[0:20]' src/content/games.json` to read first 20 records and understand structure

**Important:** If any prompt leads to needing access to ignored files, ask for clearer instructions rather than proceeding. If there's a conflict between these ignore instructions and a task requirement, clarify with the user before proceeding.
